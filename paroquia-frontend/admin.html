<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Admin</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
  </head>

  <script>
    const usuarioLogado = JSON.parse(localStorage.getItem("usuario"));

    //verifica se o usu√°rio √© admin
    if (!usuarioLogado || usuarioLogado.tipo_usuario !== "admin") {
      alert("Acesso restrito! Voc√™ ser√° redirecionado.");
      window.location.href = "index.html";
    }
  </script>

  <body>
    <header class="header">
      <a href="index.html"><button class="back-btn">&#8592;</button></a>
      <img src="img/1.png" alt="Logo da Par√≥quia" class="logo" />
    </header>

    <main class="form-container">
      <div class="form-box">
        <h1 style="text-align: center; color: #003366; margin-bottom: 20px">
          Painel de Administra√ß√£o
        </h1>

        <div
          id="admin-feedback"
          style="text-align: center; font-weight: bold; padding-bottom: 15px"
        ></div>

        <form id="form-evento-admin" class="admin-form-section">
          <h2>Cadastrar Novo Evento</h2>

          <label for="evento-titulo">T√≠tulo do Evento:</label>
          <input type="text" id="evento-titulo" name="titulo" required />

          <label for="evento-data-inicio"
            >Data de In√≠cio (para ordena√ß√£o no sistema):</label
          >
          <input
            type="date"
            id="evento-data-inicio"
            name="data_inicio"
            required
          />

          <label for="evento-data-texto"
            >Texto da Data (Ex: "De 22/09 √† 01/10"):</label
          >
          <input
            type="text"
            id="evento-data-texto"
            name="data_texto"
            required
          />

          <label for="evento-local">Local:</label>
          <input type="text" id="evento-local" name="local" required />

          <label for="evento-banner">Card do Evento:</label>
          <input
            type="file"
            id="evento-banner"
            name="banner_arquivo"
            accept="image/*"
            required
          />

          <button type="submit" class="btn-enviar">Salvar Evento</button>
        </form>

        <form id="form-midia-admin" class="admin-form-section">
          <h2>Cadastrar Nova M√≠dia</h2>

          <label for="midia-titulo">T√≠tulo da M√≠dia:</label>
          <input type="text" id="midia-titulo" name="titulo" required />

          <label for="midia-data">Data da Midia:</label>
          <input type="date" id="midia-data" name="data_evento" required />

          <label for="midia-link">Link Externo (Google Drive, etc):</label>
          <input
            type="url"
            id="midia-link"
            name="link_externo"
            placeholder="https://drive.google.com/..."
            required
          />

          <label for="midia-banner">Capa da M√≠dia (Imagem):</label>
          <input
            type="file"
            id="midia-banner"
            name="midia_arquivo"
            accept="image/*"
            required
          />

          <button type="submit" class="btn-enviar">Salvar M√≠dia</button>
        </form>
      </div>
    </main>

    <hr style="margin: 40px 0; border: 1px solid #d4a017" />

    <section style="max-width: 800px; margin: 0 auto; padding: 20px">
      <h2 style="color: #003366; text-align: center">Inten√ß√µes para Missa</h2>

      <div style="text-align: center; margin-bottom: 20px">
        <label for="filtro-data-intencao"
          ><strong>Data da Missa:</strong></label
        >
        <input
          type="date"
          id="filtro-data-intencao"
          onchange="buscarIntencoesAdmin()"
          style="
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
          "
        />
      </div>

      <div
        id="lista-intencoes-admin"
        style="display: flex; flex-direction: column; gap: 10px"
      >
        <p style="text-align: center; color: #666">
          Carregando inten√ß√µes de hoje...
        </p>
      </div>
    </section>

    <hr style="margin: 40px 0; border: 1px solid #d4a017" />

    <section
      id="secao-validacao"
      style="max-width: 800px; margin: 0 auto; padding: 20px"
    >
      <h2 style="color: #003366; text-align: center">Dizimos pendentes</h2>

      <div id="lista-pendentes">
        <p style="text-align: center">Carregando pagamentos pendentes...</p>
      </div>
    </section>

    <footer class="footer">
      <p>Par√≥quia Santa Teresinha do Menino Jesus<br />Jucati-PE</p>
    </footer>

    <script>
      async function carregarDizimosPendentes() {
        const container = document.getElementById("lista-pendentes");

        try {
          const API_URL = "https://paroquia-backend.onrender.com";
          //const API_URL = 'http://localhost:3000';

          const res = await fetch(`${API_URL}/admin/dizimos-pendentes`);
          const lista = await res.json();

          if (lista.length === 0) {
            container.innerHTML =
              "<p style='text-align:center;'>Nenhum d√≠zimo pendente.</p>";
            return;
          }

          container.innerHTML = lista
            .map(
              (dizimo) => `
        <div class="dizimo-card" style="background: white; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
          
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
            <div>
              <h3 style="margin: 0; color: #003366;">${dizimo.nome}</h3>
              <p style="margin: 5px 0;"><strong>Valor:</strong> R$ ${
                dizimo.valor
              }</p>
              <p style="margin: 5px 0;"><strong>Data:</strong><span style ="color: #d4a017;">
                 ${new Date(dizimo.data_pagamento).toLocaleDateString("pt-BR")}
              </span></p>
            </div>
            
            <div style="text-align: center;">
              <p style="font-weight: bold; margin-bottom: 5px;">Comprovante:</p>
              <img src="${
                dizimo.comprovante
              }" alt="Comprovante" style="max-width: 150px; max-height: 200px; border: 1px solid #ccc; cursor: pointer;" onclick="window.open(this.src)">
            </div>
          </div>

          <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="atualizarStatus(${
              dizimo.id
            }, 'rejeitado')" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
              Rejeitar
            </button>
            <button onclick="atualizarStatus(${
              dizimo.id
            }, 'aprovado')" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
              Aprovar
            </button>
          </div>

        </div>
      `
            )
            .join("");
        } catch (error) {
          console.error(error);
          container.innerHTML =
            "<p style='color: red; text-align: center;'>Erro ao carregar d√≠zimos.</p>";
        }
      }

      async function atualizarStatus(id, novoStatus) {
        if (!confirm(`Tem certeza que deseja marcar como ${novoStatus}?`))
          return;

        //const API_URL = 'http://localhost:3000';
        const API_URL = "https://paroquia-backend.onrender.com";

        try {
          const res = await fetch(`${API_URL}/admin/dizimos/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: novoStatus }),
          });

          if (res.ok) {
            alert("Status atualizado!");
            carregarDizimosPendentes();
          } else {
            alert("Erro ao atualizar.");
          }
        } catch (error) {
          console.error(error);
          alert("Erro de conex√£o.");
        }
      }

      carregarDizimosPendentes();

      // Fun√ß√£o para buscar e desenhar as inten√ß√µes na tela
      async function buscarIntencoesAdmin() {
        const dataInput = document.getElementById("filtro-data-intencao").value;
        const container = document.getElementById("lista-intencoes-admin");

        //const API_URL = "http://localhost:3000";
        const API_URL = "https://paroquia-backend.onrender.com";

        if (!dataInput) return;

        try {
          const res = await fetch(
            `${API_URL}/admin/intencoes?data=${dataInput}`
          );
          const lista = await res.json();

          if (lista.length === 0) {
            container.innerHTML = `
          <div style="text-align: center; padding: 20px; background: #f9f9f9; border-radius: 8px;">
            <p>Nenhuma inten√ß√£o encontrada para esta data.</p>
          </div>`;
            return;
          }

          // Monta a lista visual
          container.innerHTML = lista
            .map(
              (item) => `
        <div style="background: white; border-left: 5px solid #d4a017; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
          <div>
            <p style="margin: 0; font-size: 1.1rem; color: #333;"><strong>${item.descricao}</strong></p>
            <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #d4a017;">üë§ Pedido por: ${item.nome}</p>
          </div>
        </div>
      `
            )
            .join("");
        } catch (error) {
          console.error(error);
          container.innerHTML =
            "<p style='color: red; text-align: center;'>Erro ao buscar inten√ß√µes.</p>";
        }
      }

      window.addEventListener("load", () => {
        const inputData = document.getElementById("filtro-data-intencao");

        if (inputData) {
          inputData.valueAsDate = new Date();

          buscarIntencoesAdmin();
        }
      });
    </script>

    <style>
      .header .logo {
        margin: 0 auto;
        height: 60px;
      }
      .form-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 140px);
        background: #e0e0e0;
        padding: 20px 0;
      }
      .form-box {
        background: #f9f9f9;
        padding: 20px;
        border: 2px solid #d4a017;
        border-radius: 6px;
        width: 90%;
        max-width: 500px;
        box-sizing: border-box;
      }
      .form-box label {
        display: block;
        margin-bottom: 6px;
        margin-top: 10px;
        font-weight: bold;
        color: #333;
      }
      .form-box input[type="text"],
      .form-box input[type="date"],
      .form-box input[type="url"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 16px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 16px;
        box-sizing: border-box;
      }
      .form-box input[type="file"] {
        width: 100%;
        margin-top: 5px;
        margin-bottom: 16px;
      }
      .btn-enviar {
        background: #174a7e;
        color: white;
        font-size: 16px;
        border: none;
        padding: 12px;
        width: 100%;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 15px;
      }
      .btn-enviar:hover {
        background: #12395f;
      }
      .footer {
        color: white;
        text-align: center;
        padding: 8px;
        font-size: 14px;
        bottom: 0;
        width: 100%;
      }
      .admin-form-section {
        border-top: 2px solid #eee;
        padding-top: 20px;
        margin-top: 20px;
      }
      .admin-form-section:first-of-type {
        border-top: none;
        margin-top: 0;
        padding-top: 0;
      }
    </style>

    <script src="app.js"></script>
  </body>
</html>
